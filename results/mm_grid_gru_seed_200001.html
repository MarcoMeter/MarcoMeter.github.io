<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;500&display=swap" rel="stylesheet"/>
    <script src="template/cdn.plot.ly_plotly-2.6.3.min.js"></script>
    <style>
     /* Style the body */
      html, body {
        height: 100%;
        margin: 0;
        background-color: #000;
        color: white;
        font-family: "Montserrat", sans-serif;
        min-width: 1737px;
      }

      /* Set the width and hight of the video*/
      video {
        width: 600px;
        height: 400px;
      }

      /* Style the timeline text*/
      #selector_header {
        font-weight: 200;
      }

      /* Buttons should be displayed in a row */
      buttonrow {
        display: inline;
      }

      /* Style the figures */
      #figures {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        flex-flow: row nowrap;
      }

      /* Style the tab */
      .tab {
        overflow: hidden;
        background-color: #54595f;
      }

      /* Style the buttons inside the tab */
      .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
        color: white;
      }

      /* Change background color of buttons on hover */
      .tab button:hover {
        background-color: #909090;
      }

      /* Create an active/current tablink class */
      .tab button.active {
        background-color: #838383;
      }

      /* Style the tab content */
      .tabcontent {
        display: none;
        padding: 6px 12px;
        border-top: none;
        background-color: #000;
      }

      .mediatabcontent {
        display: none;
        padding: 0 px 0 px;
        border-top: none;
        background-color: #000;
        width: 100%;
        height: 100%;
      }

      /* Style the close button */
      .topright {
        float: right;
        cursor: pointer;
        font-size: 28px;
      }

      .topright:hover {
        color: red;
      }

      /* Style of the dropdown button */
      .dropbtn {
        background-color: #17202A;
        color: white;
        padding: 16px;
        font-size: 16px;
        border: none;
      }
      
      .dropdown {
        position: relative;
        display: inline-block;
      }
      
      /* Style of the dropdown content */
      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        background-color: #A6ACAF;
        z-index: 1;
      }
      
      .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
      }

      .gotostepcontainer {
          margin-bottom: 10px;
      }
      
      #score-container label, #score-container input {
        display: inline-block;
      }

      /* Style of the dropdown at hover */
      .dropdown-content a:hover {background-color: #ddd;}
      
      .dropdown:hover .dropdown-content {display: block;}
      
      .dropdown:hover .dropbtn {background-color: #161515;}
    </style>
  </head>
  <body>
    <!--- Define tabs -->
    <div class="tab">
      <button class="tablinks" onclick="location.href='../index.html'">Back</button>
      <button class="tablinks" onclick="openTab(event, 'Environment')">Environment</button>
      <button class="tablinks" onclick="openTab(event, 'Sampler')">Sampler</button>
      <button class="tablinks" onclick="openTab(event, 'Hyperparameters')">Hyperparameters</button>
      <button class="tablinks" onclick="openTab(event, 'Model')">Model</button>
      <button class="tablinks" onclick="openTab(event, 'Media')" id="defaultOpen">Media</button>
    </div>

    <!--- Define tab content -->
    <div id="Environment" class="tabcontent">
      <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
      <b>type</b>: MemoryGym<br><b>name</b>: MortarMayhem-Grid-v0<br><b>frame_skip</b>: 1<br><b>last_action_to_obs</b>: False<br><b>last_reward_to_obs</b>: False<br><b>obs_stacks</b>: 1<br><b>grayscale</b>: False<br><b>resize_vis_obs</b>: [84, 84]<br><b>positional_encoding</b>: False<br><b>reset_params</b>: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>start-seed</b>: 200001<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>num-seeds</b>: 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>agent_scale</b>: 0.25<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>arena_size</b>: 5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>allowed_commands</b>: 5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>command_count</b>: [10]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>command_show_duration</b>: [3]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>command_show_delay</b>: [1]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>explosion_duration</b>: [2]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>explosion_delay</b>: [6]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>reward_command_failure</b>: 0.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>reward_command_success</b>: 0.1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>reward_episode_success</b>: 0.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>seed</b>: 200001<br><b>reward_normalization</b>: 0<br><b>positional_endocing</b>: False<br>
    </div>

    <div id="Model" class="tabcontent">
      <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
      <b>load_model</b>: False<br><b>model_path</b>: <br><b>checkpoint_interval</b>: 500<br><b>activation</b>: relu<br><b>vis_encoder</b>: cnn<br><b>vec_encoder</b>: linear<br><b>num_vec_encoder_units</b>: 128<br><b>hidden_layer</b>: default<br><b>num_hidden_layers</b>: 1<br><b>num_hidden_units</b>: 512<br><b>recurrence</b>: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>layer_type</b>: gru<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>sequence_length</b>: -1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>hidden_state_size</b>: 512<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>hidden_state_init</b>: zero<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>reset_hidden_state</b>: True<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>residual</b>: False<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>num_layers</b>: 1<br>
    </div>

    <div id="Sampler" class="tabcontent">
      <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
      <b>n_workers</b>: 32<br><b>worker_steps</b>: 512<br>
    </div>

    <div id="Hyperparameters" class="tabcontent">
      <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
      <b>algorithm</b>: PPO<br><b>resume_at</b>: 0<br><b>gamma</b>: 0.995<br><b>lamda</b>: 0.95<br><b>updates</b>: 10000<br><b>epochs</b>: 3<br><b>refresh_buffer_epoch</b>: -1<br><b>n_mini_batches</b>: 8<br><b>advantage_normalization</b>: no<br><b>value_coefficient</b>: 0.5<br><b>max_grad_norm</b>: 0.25<br><b>share_parameters</b>: True<br><b>learning_rate_schedule</b>: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>initial</b>: 0.000275<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>final</b>: 1e-05<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>power</b>: 1.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>max_decay_steps</b>: 10000<br><b>beta_schedule</b>: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>initial</b>: 0.0001<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>final</b>: 1e-06<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>power</b>: 1.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>max_decay_steps</b>: 10000<br><b>clip_range_schedule</b>: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>initial</b>: 0.1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>final</b>: 0.1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>power</b>: 1.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>max_decay_steps</b>: 10000<br><b>obs_reconstruction_schedule</b>: {'initial': 0.0}<br>
    </div>

    <div id="Media" class="mediatabcontent">
      <br>
      <center>
        <div id="figures" style="display: flex; flex-direction: column;">
          <div style="display: flex; flex-direction: row;">
            <div style="display: flex; flex-direction: column;">
              <div style="display: flex; flex-direction: row;">
                <label for="video_speed">Frame Rate: </label>
                <input type="text" id="video_speed" size="3" value="6" onkeydown="set_video_speed(event)">
              </div>

              <div style="display: flex; flex-direction: row;">
                <label for="show_ground_truth">Show Ground Truth Estimation</label>
                <input type="checkbox" id="show_ground_truth" onclick="show_ground_truth()">
              </div>

              <div style="display: flex; flex-direction: row;">
                <label for="show_decoder_video">Show Decoder Video</label>
                <input type="checkbox" id="show_decoder_video" onclick="show_decoder_video()">
              </div>

            <div style="display: flex; flex-direction: row;">
              <label for="show_agent_video">Show Agent Video</label>
              <input type="checkbox" id="show_agent_video" onclick="show_agent_video()">
            </div>
          </div>
          
            <div>
              <video id="video_player">
                <source src="" type="video/webm" />
              </video>
            </div>
            <div id="action_distr"></div>
          </div>
        </div>

        <br>
        <!-- Set buttons to control the figures -->
        <div class="gotostepcontainer">
          <label for="gotostep_text">Step:</label>
          <input type="text" id="gotostep_text" size="3" value="0" onkeydown="go_to_step(event)">
          <button id="return_button" type="return_button" onclick="return_to_step()">Return to step 0</button>
        </div>
        <buttonrow>
          <button id="play_pause_button" onclick="play_pause()" style="width:53px">Play</button>
          <button id="reset_button" onclick="reset()">Reset</button>
          <button id="back_button" onclick="back()">Back</button>
          <button id="next_button" onclick="next()">Next</button>
          <button id="stats_button" onclick="statistic()">Attention Scores</button>
        </buttonrow>
        <br>
        <!-- Set slider to control the figures -->
        <input id="time_selector" type="range" min="0" max="100" step="1" value="0" style="width: 300px;"/>

        <!-- Set transformer plot -->
        <div id="score-container">
          <label for="top_n_scores">Number of Top Attention Scores:</label>
          <input type="text" id="top_n_scores" size="3" value="-1" onkeydown="top_scores()">
        </div>
        <div id="transformer"></div>

        <!-- Set value plot and entropy plot -->
        <div id="figures">
          <div id="value_func"></div>
          <div id="entropy_func"></div>
          <!-- Dropdown button with some options-->
          <div class="dropdown" id="options">
            <button class="dropbtn">Options</button>
            <div class="dropdown-content" id="dropdown_content">
              <a href ="#" onclick="marker('value')">value_marker_toggle</a>
              <a href ="#" onclick="marker('entropy')">entropy_marker_toggle</a>
              <a href="#" id="all" onclick="set_action_space('all')">All</a>
            </div>
          </div>
        </div>
      </center>
    </div>

    <script>
        // Set active tab
        document.getElementById("defaultOpen").click();

        // Set video player
        const video_player = document.getElementById("video_player");
        const video_speed = document.getElementById("video_speed");
        const video_path = ['videos/video_seed_200001_103.webm', '', '', '', 'videos/video_seed_200001_104.webm', ''];
        var render_id = 0; var render_gt_id = 1; var render_decoder_id = 2; var render_decoder_gt_id = 3; var  render_agent_id = 4; var render_agent_gt_id = 5;
        var video_id = 0;
        // Hide video player if there is no ground truth video
        if (video_path[render_gt_id].length == 0 && video_path[render_decoder_gt_id].length == 0 && video_path[render_agent_gt_id].length == 0){
          document.querySelector('label[for="show_ground_truth"]').style.display = 'none';
          document.getElementById("show_ground_truth").style.display = 'none';
        } 
        if (video_path[render_decoder_id].length == 0){
          document.querySelector('label[for="show_decoder_video"]').style.display = 'none';
          document.getElementById("show_decoder_video").style.display = 'none';
        }
        if (video_path[render_agent_id].length == 0){
          document.querySelector('label[for="show_agent_video"]').style.display = 'none';
          document.getElementById("show_agent_video").style.display = 'none';
        }

        video_player.querySelector("source").src = video_path[0];
        video_player.load();
        var video_length = 0;

        // Play and pause button
        const play_pause_button = document.getElementById("play_pause_button");

        // Set step input
        const gotostep_text = document.getElementById('gotostep_text');
        var past_steps = [0];
        var step = 0;

        // Set number of scores input
        const top_n_scores = document.getElementById('top_n_scores');

        // Const stats button
        const stats_button = document.getElementById("stats_button");

        // Set time selector
        const time_selector = document.getElementById('time_selector');
        var tS_step_size = 1.0;

        // Set values for the plots
        var y_values = [[0.6677944660186768], [0.672132134437561], [0.6761349439620972], [0.6801169514656067], [0.6840174794197083], [0.6874299049377441], [0.6911441087722778], [0.6946380734443665], [0.6980991959571838], [0.6999514698982239], [0.7016518115997314], [0.7082148790359497], [0.7111777067184448], [0.7150920629501343], [0.7177184820175171], [0.7234832048416138], [0.7259663343429565], [0.7312061786651611], [0.7338099479675293], [0.7374271154403687], [0.7418922185897827], [0.7459355592727661], [0.7483532428741455], [0.7510101795196533], [0.7557964324951172], [0.759198784828186], [0.7623564004898071], [0.7645127773284912], [0.7684954404830933], [0.7729024887084961], [0.7773618698120117], [0.7815834283828735], [0.7880599498748779], [0.789046049118042], [0.7931399345397949], [0.7966852188110352], [0.8026244640350342], [0.8039239645004272], [0.8092007637023926], [0.8111746311187744], [0.814170241355896], [0.8213281631469727], [0.8243850469589233], [0.8290390968322754], [0.8310695886611938], [0.8365544080734253], [0.7386577129364014], [0.7403008937835693], [0.747151255607605], [0.7486789226531982], [0.7543505430221558], [0.7552697658538818], [0.7642223834991455], [0.7670352458953857], [0.6700315475463867], [0.6708692312240601], [0.6752749681472778], [0.6773289442062378], [0.6848540306091309], [0.6845782399177551], [0.6877912282943726], [0.6877923011779785], [0.5955567359924316], [0.5954792499542236], [0.6012563705444336], [0.6058797836303711], [0.6086532473564148], [0.6099241971969604], [0.6188303232192993], [0.6170399188995361], [0.5210345387458801], [0.5229293704032898], [0.5290697813034058], [0.5288980007171631], [0.5330245494842529], [0.5383163094520569], [0.5404210090637207], [0.5406779050827026], [0.4452003538608551], [0.4486082196235657], [0.45011210441589355], [0.45503419637680054], [0.4539566934108734], [0.45668092370033264], [0.45574262738227844], [0.4571470022201538], [0.3597395420074463], [0.3629388213157654], [0.3653707504272461], [0.36409157514572144], [0.3677281439304352], [0.3709728717803955], [0.37332725524902344], [0.37503522634506226], [0.27760419249534607], [0.2766720652580261], [0.2812574505805969], [0.28223955631256104], [0.2837512195110321], [0.2836979627609253], [0.28882044553756714], [0.286702424287796], [0.18872621655464172], [0.1898205280303955], [0.19032181799411774], [0.1923746019601822], [0.1939113438129425], [0.19532161951065063], [0.19272024929523468], [0.1944892406463623], [0.0966448038816452], [0.0998103991150856], [0.10292527824640274], [0.10331040620803833], [0.10092739760875702], [0.09994378685951233], [0.09909304976463318], [0.1037973016500473], [0.04941943287849426]];
        var y_entropy = [[1.2561877965927124], [1.3678514957427979], [1.3732259273529053], [1.3243274688720703], [1.334510326385498], [1.3425135612487793], [1.1762958765029907], [0.7158653736114502], [1.3158478736877441], [1.3177897930145264], [1.337565302848816], [1.2325730323791504], [1.3677968978881836], [1.3200619220733643], [1.31172776222229], [0.9197169542312622], [1.3663655519485474], [1.3224661350250244], [1.3023779392242432], [0.9815492630004883], [1.37391996383667], [1.3396905660629272], [1.3140733242034912], [0.913124144077301], [1.341275691986084], [1.3405704498291016], [1.33188796043396], [0.6048756241798401], [1.3158735036849976], [1.3506765365600586], [1.3418772220611572], [0.4768165051937103], [1.2155399322509766], [1.2924044132232666], [1.2992795705795288], [0.5435653328895569], [0.9555457234382629], [1.1594494581222534], [1.1431399583816528], [0.7307575941085815], [0.0014592059887945652], [2.107555907571168e-09], [1.2204064887555433e-06], [1.8545406321734959e-09], [0.6637213826179504], [1.0539530515670776], [0.9174085855484009], [0.9964730143547058], [0.00013960020442027599], [1.5654061976799055e-13], [2.1668084571047075e-07], [1.3241702845334657e-08], [0.7548186182975769], [0.9640522003173828], [1.0308302640914917], [0.8325390219688416], [1.0670737028121948], [6.647998418429779e-08], [1.0863377038206057e-11], [3.871496439405986e-12], [0.7350273728370667], [1.084879755973816], [1.0823912620544434], [0.8548333048820496], [0.6203359365463257], [4.801100406126579e-09], [6.394510615459481e-11], [9.087114563044452e-07], [4.285567229089793e-06], [1.212747702084016e-05], [1.0759365558624268], [0.9436754584312439], [0.9402503967285156], [8.595006306677533e-08], [3.4803459669774384e-08], [7.750621477953246e-08], [2.5745358969708754e-11], [0.8246205449104309], [1.0565365552902222], [1.0306174755096436], [1.0083848237991333], [2.775024370293977e-07], [3.9519346017868884e-08], [4.32935715055649e-10], [0.6970980167388916], [0.9000803232192993], [1.0674046277999878], [1.0873267650604248], [1.0597378015518188], [2.6961199637298705e-06], [7.992125711231424e-11], [5.847579359397059e-06], [2.0955494619556703e-05], [1.0235780477523804], [1.0235307216644287], [0.9992350935935974], [0.9185505509376526], [1.8266896972818358e-07], [9.735759420870238e-11], [6.931360530870734e-06], [1.2113730008422863e-05], [0.9060429930686951], [0.9746327996253967], [0.8322189450263977], [1.0961533784866333], [1.4111905329627916e-05], [1.4167726192226837e-07], [3.37727828991774e-06], [0.35165372490882874], [0.40835800766944885], [1.011738657951355], [0.9898982644081116], [0.7562825083732605], [4.066263045388041e-06], [6.170044798636809e-06], [1.9197179881302873e-06], [1.0506933278975339e-07], [0.7246387004852295], [0.9707663655281067]];
        var y_attention_weights = [];
        var y_action = [[[0.17019684612751007, 0.13700100779533386, 0.21389339864253998, 0.4789087474346161]], [[0.25736233592033386, 0.21636483073234558, 0.20002514123916626, 0.3262476325035095]], [[0.258049875497818, 0.31243813037872314, 0.22513264417648315, 0.20437932014465332]], [[0.25147688388824463, 0.3954097628593445, 0.15766631066799164, 0.19544701278209686]], [[0.1209123358130455, 0.2930245101451874, 0.2942425012588501, 0.2918206453323364]], [[0.14594914019107819, 0.22215649485588074, 0.30186793208122253, 0.33002644777297974]], [[0.10934817045927048, 0.134369358420372, 0.2170250564813614, 0.5392574071884155]], [[0.010812164284288883, 0.0329391248524189, 0.21667875349521637, 0.7395699620246887]], [[0.18651083111763, 0.39952388405799866, 0.2640756368637085, 0.14988960325717926]], [[0.29512327909469604, 0.35647886991500854, 0.23107272386550903, 0.11732510477304459]], [[0.3372129499912262, 0.2963394820690155, 0.2284911572933197, 0.13795636594295502]], [[0.04979701340198517, 0.2914438843727112, 0.27907541394233704, 0.3796837031841278]], [[0.30576667189598083, 0.179794043302536, 0.23725531995296478, 0.27718403935432434]], [[0.3562493324279785, 0.12906210124492645, 0.3091217875480652, 0.20556679368019104]], [[0.3284453749656677, 0.10996637493371964, 0.3336524963378906, 0.22793571650981903]], [[0.01257140189409256, 0.06811822950839996, 0.3374928832054138, 0.5818175077438354]], [[0.3378154933452606, 0.20850740373134613, 0.23326320946216583, 0.22041386365890503]], [[0.2871081531047821, 0.12273754924535751, 0.3581276834011078, 0.23202665150165558]], [[0.26322099566459656, 0.10576112568378448, 0.38284385204315186, 0.2481740266084671]], [[0.013000845909118652, 0.08538064360618591, 0.48953139781951904, 0.41208717226982117]], [[0.3193851709365845, 0.22684404253959656, 0.21986845135688782, 0.23390226066112518]], [[0.2621364891529083, 0.1362718790769577, 0.3417433798313141, 0.25984829664230347]], [[0.24809008836746216, 0.11323495209217072, 0.3680686354637146, 0.27060627937316895]], [[0.009296096861362457, 0.0944141373038292, 0.626022458076477, 0.2702672779560089]], [[0.2882899045944214, 0.290336936712265, 0.29247403144836426, 0.12889914214611053]], [[0.22035986185073853, 0.1758154034614563, 0.38199329376220703, 0.22183135151863098]], [[0.2286440134048462, 0.15096122026443481, 0.38274410367012024, 0.23765064775943756]], [[0.00791978556662798, 0.139298215508461, 0.8145146369934082, 0.038267333060503006]], [[0.28968095779418945, 0.34472861886024475, 0.2575080692768097, 0.10808243602514267]], [[0.2240515798330307, 0.22895169258117676, 0.3649369776248932, 0.18205967545509338]], [[0.23644830286502838, 0.18100674450397491, 0.37931740283966064, 0.20322760939598083]], [[0.010567273944616318, 0.13753965497016907, 0.849001944065094, 0.002891171257942915]], [[0.37305858731269836, 0.30754929780960083, 0.2793712913990021, 0.040020834654569626]], [[0.3345416486263275, 0.22694535553455353, 0.34441104531288147, 0.0941019356250763]], [[0.3480498194694519, 0.21122623980045319, 0.33534055948257446, 0.10538334399461746]], [[0.014822062104940414, 0.17855137586593628, 0.8066115975379944, 1.4979310435592197e-05]], [[0.5213064551353455, 0.40145760774612427, 0.0468364842236042, 0.030399445444345474]], [[0.5046567916870117, 0.29080724716186523, 0.13583210110664368, 0.06870383024215698]], [[0.5222244262695312, 0.26228466629981995, 0.1607641577720642, 0.05472671613097191]], [[0.026774102821946144, 0.3079240620136261, 0.6653016805648804, 1.269905283152184e-07]], [[6.157421807984065e-07, 0.00014761861530132592, 0.9998517036437988, 1.77339479906502e-11]], [[8.92486293202488e-11, 1.5587756779789075e-12, 1.0, 3.5271452812210255e-18]], [[5.531444458029e-08, 1.0, 2.2683363520847877e-10, 1.6226707089117554e-08]], [[1.8578929085293072e-13, 1.504296315368392e-15, 7.951121011595674e-11, 1.0]], [[0.3342573940753937, 0.6613236665725708, 0.004418770782649517, 2.687237099507911e-07]], [[0.3102719187736511, 0.46600422263145447, 0.22372186183929443, 2.057006895483937e-06]], [[0.6192725896835327, 0.23571842908859253, 0.1450088769197464, 1.0479427655502027e-12]], [[0.2878247797489166, 0.17426913976669312, 0.5379060506820679, 3.0608306687829323e-12]], [[1.1084715879405849e-05, 1.0453483412220521e-07, 0.9999887943267822, 1.3467354022755445e-16]], [[4.718661306959623e-15, 2.310178966059535e-17, 1.0, 9.183407871146889e-25]], [[1.1864604410050106e-08, 1.0, 1.266758507985355e-12, 4.620125462762026e-12]], [[1.4516672369388472e-12, 1.1525005566049868e-14, 6.228197402258218e-10, 1.0]], [[0.4625963270664215, 0.5235172510147095, 0.013886445201933384, 6.043370248676183e-09]], [[0.18986937403678894, 0.5859673023223877, 0.22414439916610718, 1.8850307242246345e-05]], [[0.25793275237083435, 0.5113593339920044, 0.23070789873600006, 3.997423725365934e-09]], [[0.12245166301727295, 0.19177713990211487, 0.6857711672782898, 1.349416400842074e-08]], [[0.3915567696094513, 0.3892878592014313, 0.21915532648563385, 2.78748335524881e-09]], [[3.403223480802353e-09, 1.0, 4.679679820734917e-12, 7.429779939601895e-24]], [[3.797366338476743e-13, 1.0, 8.583618144004796e-17, 5.7277085076019864e-30]], [[1.294346845415878e-13, 7.657824764592341e-16, 1.0297336526378676e-16, 1.0]], [[0.6596034169197083, 0.02675662562251091, 0.313639760017395, 1.2908660096400126e-07]], [[0.3772609233856201, 0.36555537581443787, 0.2571837306022644, 3.118727676110211e-08]], [[0.2550455331802368, 0.3982345163822174, 0.3467198610305786, 8.705426601807176e-09]], [[0.13484519720077515, 0.19310542941093445, 0.672049343585968, 1.9324508659934736e-09]], [[0.17482426762580872, 0.038929883390665054, 0.7862458825111389, 1.5598337899103143e-10]], [[2.155172151852014e-10, 1.3925914186998373e-13, 1.0, 4.1230897528538145e-23]], [[2.3888430296381546e-12, 1.0, 5.45021655844885e-16, 3.636661192894956e-21]], [[3.654740121650235e-10, 1.569245332691084e-17, 1.0, 5.381688694683362e-08]], [[2.8373528948577587e-07, 0.9999997615814209, 2.5161259187278517e-10, 1.1502888919157073e-10]], [[6.845092457297142e-07, 5.030346983403433e-08, 3.569663675762058e-08, 0.9999992847442627]], [[0.3521825969219208, 0.4076365828514099, 0.24018032848834991, 5.094878474665165e-07]], [[0.18318499624729156, 0.21180377900600433, 0.6050112247467041, 2.715990277124547e-08]], [[0.366299033164978, 0.10423974692821503, 0.5294612050056458, 1.273744665297727e-09]], [[4.3839674113144156e-09, 6.743165054112765e-11, 1.0, 1.1430833118677298e-20]], [[1.074364042175091e-09, 1.0, 6.91804807884111e-11, 5.141922443385738e-10]], [[4.0074539242596074e-09, 7.763074579870965e-13, 1.0, 3.045621308667309e-22]], [[3.306672630479755e-14, 8.905316263053964e-13, 2.6247968142590586e-16, 1.0]], [[0.6336776614189148, 0.30363672971725464, 0.06268558651208878, 8.691264596905057e-09]], [[0.4524988830089569, 0.21762004494667053, 0.3298809230327606, 7.576104366080472e-08]], [[0.33381858468055725, 0.18521557748317719, 0.4809657335281372, 1.1151427514732859e-07]], [[0.513586163520813, 0.3150656819343567, 0.17134806513786316, 1.5016085797014966e-07]], [[1.535540405939173e-08, 1.0, 5.1948861878869934e-11, 2.975524422124329e-14]], [[1.9657089289637497e-09, 4.277173667327494e-12, 1.0, 2.7482530349828004e-26]], [[8.602562157631125e-14, 1.736776347738278e-11, 1.0714528443216695e-15, 1.0]], [[0.7337715029716492, 0.22328560054302216, 0.04294279217720032, 8.700045128762213e-08]], [[0.5962181687355042, 0.30419325828552246, 0.09958801418542862, 5.590976002167736e-07]], [[0.4532947838306427, 0.2827492952346802, 0.2639558017253876, 1.479225062439582e-07]], [[0.40527448058128357, 0.2980997860431671, 0.29662537574768066, 2.5950549797926215e-07]], [[0.35755112767219543, 0.4300038516521454, 0.21244461834430695, 3.794368126364134e-07]], [[1.7275982600040152e-07, 0.9999998807907104, 2.7310520511747427e-10, 3.182308738534817e-17]], [[3.0059084561717686e-12, 1.0, 5.267421766233689e-15, 6.22764559047788e-38]], [[3.9634397808185895e-07, 0.9999996423721313, 2.2879539929299142e-10, 3.144805650698995e-14]], [[7.476232326553145e-07, 8.280325403120514e-08, 5.632807074107404e-07, 0.9999985694885254]], [[0.2876772880554199, 0.20066805183887482, 0.5116546154022217, 4.377932238952553e-09]], [[0.47293969988822937, 0.3564552068710327, 0.17060504853725433, 3.3422534073679344e-08]], [[0.5215818881988525, 0.3152480125427246, 0.16317003965377808, 5.262015179141599e-08]], [[0.6117057800292969, 0.2537192702293396, 0.13457463681697845, 2.8699503218376776e-07]], [[9.898605490832324e-09, 1.0, 9.005191557720504e-12, 1.2797648746497813e-17]], [[3.689680071888857e-12, 6.899164247032739e-15, 1.0, 5.732986683342842e-19]], [[4.7459144525419106e-07, 0.9999995231628418, 9.888349028486232e-10, 1.6978637246145567e-11]], [[5.795399147245917e-07, 4.0848256332992605e-08, 1.3546363675231987e-07, 0.9999992847442627]], [[0.6189048886299133, 0.1254066377878189, 0.2556873857975006, 1.1045256087527378e-06]], [[0.459380179643631, 0.42175498604774475, 0.118863046169281, 1.879849492070207e-06]], [[0.2670908272266388, 0.6533065438270569, 0.07959859073162079, 4.153007012064336e-06]], [[0.3139594495296478, 0.31773698329925537, 0.36827918887138367, 2.4420563931926154e-05]], [[9.472774991081678e-07, 0.9999990463256836, 9.533536182715352e-10, 4.493168854422793e-16]], [[9.450405041855348e-11, 1.0, 7.453881067931434e-09, 4.050408290009548e-25]], [[5.452618268009246e-08, 1.5705929001796903e-07, 2.137123672474317e-10, 0.9999997615814209]], [[0.0926213264465332, 0.007427812088280916, 0.8999507427215576, 1.339440416359139e-07]], [[0.07357605546712875, 0.033947400748729706, 0.892476499080658, 1.9590064292973608e-10]], [[0.4710671901702881, 0.3735466003417969, 0.15538617968559265, 4.004251152878169e-09]], [[0.24945423007011414, 0.5572566390037537, 0.19328850507736206, 5.788238013337832e-07]], [[0.07584796100854874, 0.20396935939788818, 0.7201825380325317, 4.796069319468188e-08]], [[2.1166809460737568e-07, 0.9999997615814209, 4.8062776869528534e-08, 1.5040013678913056e-10]], [[3.919603557278606e-07, 0.9999996423721313, 2.1143435446902004e-08, 6.703003707642097e-10]], [[1.1220274132028862e-07, 6.590094692171533e-09, 0.9999998807907104, 2.2063386410675376e-18]], [[7.415869307525469e-11, 5.360285548761112e-09, 5.313080878033283e-11, 1.0]], [[0.7553202509880066, 0.13547548651695251, 0.1092008650302887, 3.368309762663557e-06]], [[0.5634470582008362, 0.27862417697906494, 0.1579286754131317, 3.518827540460734e-08]]]; // action probs
        var action =  [[3], [2], [1], [3], [1], [0], [3], [3], [2], [1], [3], [2], [2], [3], [0], [3], [3], [0], [2], [2], [0], [1], [2], [3], [2], [0], [2], [2], [1], [2], [2], [1], [2], [2], [1], [2], [0], [2], [1], [2], [2], [2], [1], [3], [0], [1], [0], [0], [2], [2], [1], [3], [1], [2], [1], [1], [1], [1], [1], [3], [0], [1], [1], [1], [0], [2], [1], [2], [1], [3], [1], [2], [0], [2], [1], [2], [3], [0], [0], [0], [0], [1], [2], [3], [0], [0], [0], [0], [0], [1], [1], [1], [3], [1], [2], [1], [0], [1], [2], [1], [3], [0], [0], [0], [2], [1], [1], [3], [2], [2], [1], [1], [1], [1], [1], [2], [3], [0], [0]];
        var action_names = [['no-op', 'rotate left', 'rotate right', 'move forward']];
        var x_values = [...Array(y_values.length).keys()];

        var y_entropy_plot = [];
        var y_values_plot = [];

        // Set marker for plots
        var entropy_marker = false;
        var value_marker = false;

        // Set the to be shown statistic
        var statistic_type = 'general'
        // Only used for the transformer plot to show the correct statistic with tab switching
        var statistic_plot_id = 0;
        // Hide statistic type button if there is no attention weights
        if(y_attention_weights.length == 0) stats_button.style.display = 'none';

        // Set the to be shown action_space(s) for the entropy plot
        var entr_selected_action_space = null;

        var is_multi_discrete = action[0].length != 1;
        var is_discrete = action[0].length == 1;

        // Reformat the data for the plots
        // Each function y - value should be stored in a separate array
        for(var j = 0; j < y_values[0].length; j++)
            for(var i = 0; i < y_values.length; i++)
                y_values_plot.push(y_values[i][j]);

        if(is_discrete) { // If action_space is discrete
          for(var j = 0; j < y_entropy[0].length; j++)
              for(var i = 0; i < y_values.length; i++)
                  y_entropy_plot.push(y_entropy[i][j]);
        }
        else { // If action_space is multi discrete
          for(var j = 0; j < y_entropy[0].length; j++) {
            var y_entropy_vals = [];
            for(var i = 0; i < y_entropy.length; i++) {
                y_entropy_vals.push(y_entropy[i][j]);
            }
            y_entropy_plot.push(y_entropy_vals);
          }
        }

        // Set action_names for distr. plot if it does not exist
        if(action_names == null){
          action_names = [];
          for(var i = 0; i < y_action[0].length; i++){
            for(var j = 0; j < y_action[0][0].length; j++)
              if(is_discrete){ // if action space is discrete
                action_names.push("action_" + String(j));
            }
            else { // if action space is multi_discrete
              var action_branch_names = []; // Names of the branches of the action space
              for(var j = 0; j < y_action[0][i].length; j++){
                action_branch_names.push("action_" + String(j));
              }
              action_names.push(action_branch_names);
            }     
          }
        }
        else{
          if(action[0].length == 1 && Array.isArray(action_names[0])){ // If action space is discrete and action_names is multi_discrete
            action_names = action_names[0]; // Set action_names to the first branch of the action space
          }
        }

        // Modify dropdown menu
        if(is_discrete){ // if action space is discrete
          document.getElementById("all").outerHTML=""; // remove dropdown option 'all'
        }
        else { // If action space is multi_discrete
          // Create dropdown menu for the entropy function
          var dropdown_content = document.getElementById("dropdown_content"); 
          for(var i = 0; i < action[0].length; i++){
            var entropy_dropdown_option = document.createElement("a");
            entropy_dropdown_option.innerHTML = "action_space_" + String(i);
            entropy_dropdown_option.setAttribute("href", "#");
            entropy_dropdown_option.setAttribute("onclick", "set_action_space(" + String(i) + ")");
            dropdown_content.appendChild(entropy_dropdown_option);
          }
        }

        window.addEventListener('load', () => {
          // Set video length to length - 0.9999 because the last frame is two seconds long
          video_length = video_player.duration - 0.9999;
          time_selector.setAttribute('max', video_length); // Set max value of time selector to video length

          video_player.addEventListener('timeupdate', timeListener); // Update time selector and plots when video is playing
          video_player.addEventListener('dblclick', function(e) {open_fullscreen(video_player);}); // Open video in fullscreen when video is double clicked
          video_player.playbackRate = 6; // Set video playback rate to frame rate
          reset(); // Reset video to start
        }, false);
      
      // Update video time if time selector is changed
      time_selector.addEventListener('input', () => {
          video_player.currentTime = time_selector.value
          pause();
          update();
      })

      // Add event manager for tab
      window.addEventListener('keydown', function(event) {
          if (event.key === 'Tab') {
              if (statistic_type == "transformer") {
                statistic_plot_id = (statistic_plot_id + 1) % 3;
                // Set action plot if statistic_plot_id is 0
                if(statistic_plot_id == 0){
                  // Update action plot
                  if(is_discrete) { // If action_space is discrete
                    set_bar_action_plot(y_action[step][0], action[step][0], action_names);
                  }
                  else { // If action_space is multi discrete
                      set_stacked_bar_action_plot(y_action[step], action[step], action_names);
                  }
                }
                // Set value plot if statistic_plot_id is 1
                if (statistic_plot_id == 1) {
                  set_scatter_line_plot('action_distr', "Value Function", y_values_plot, step, value_marker);
                }

              // Set entropy plot if statistic_plot_id is 2
              if (statistic_plot_id == 2) {
                  if(is_discrete) { // If action_space is discrete
                      set_scatter_line_plot('action_distr', "Entropy Function", y_entropy_plot, step, entropy_marker);
                  }
                  else { // If action_space is multi discrete
                      set_scatter_lines_plot('action_distr', "Entropy Function", y_entropy_plot, step, entropy_marker);
                  }
              }
          }
      }
    });

    // Show ground truth if checkbox is checked
    function show_ground_truth() {
        // Get the checkbox element by its ID
        var checkbox = document.getElementById("show_ground_truth");
        
        // Check if the checkbox is checked
        if (checkbox.checked) { // Show the ground truth
          if (video_id == render_id) video_id = render_gt_id;
          if (video_id == render_decoder_id) video_id = render_decoder_gt_id;
          if (video_id == render_agent_id) video_id = render_agent_gt_id;
          set_video(video_path[video_id]);
        } else {
          if (video_id == render_gt_id) video_id = render_id;
          if (video_id == render_decoder_gt_id) video_id = render_decoder_id;
          if (video_id == render_agent_gt_id) video_id = render_agent_id;
          set_video(video_path[video_id]);
        }
      }

    // Show decoder video if checkbox is checked
    function show_decoder_video() {
      var checkbox = document.getElementById("show_decoder_video");
      document.getElementById("show_agent_video").checked = false;

      if (checkbox.checked) { 
          if (video_id == render_id) video_id = render_decoder_id;
          if (video_id == render_gt_id) video_id = render_decoder_gt_id;
          if (video_id == render_agent_id) video_id = render_decoder_id;
          if (video_id == render_agent_gt_id) video_id = render_decoder_gt_id;
          set_video(video_path[video_id]);
        } else { // Hide decoder video
          if (video_id == render_decoder_id) video_id = render_id;
          if (video_id == render_decoder_gt_id) video_id = render_gt_id;
          set_video(video_path[video_id]);
        }
    }

    // Show agent video if checkbox is checked
    function show_agent_video() {
      var checkbox = document.getElementById("show_agent_video");
      document.getElementById("show_decoder_video").checked  = false;

      if (checkbox.checked) { 
          if (video_id == render_id) video_id = render_agent_id;
          if (video_id == render_gt_id) video_id = render_agent_gt_id;
          if (video_id == render_decoder_id) video_id = render_agent_id;
          if (video_id == render_decoder_gt_id) video_id = render_agent_gt_id;
          set_video(video_path[video_id]);
        } else { // Hide agent video
          if (video_id == render_agent_id) video_id = render_id;
          if (video_id == render_agent_gt_id) video_id = render_gt_id;
          set_video(video_path[video_id]);
        }
    }

    // Set the video to the given path
    function set_video(path) {
        // Get video data to make the switch seamless
        var current_time = video_player.currentTime;
        var play_back_rate = video_player.playbackRate;
        var is_paused = video_player.paused;
        video_player.querySelector("source").src = path;
        // Reload video
        video_player.load();
        video_player.currentTime = current_time;
        video_player.playbackRate = play_back_rate;
        if(is_paused) pause();
        else play();
    }


      /**
      * Update time selector and plots when video is playing
      */
      function timeListener() {
        if(!video_player.paused) {
          update();
        } 
      }

      /**
      * Toggles button and video between playing and paused
      */
      function play_pause() {
        if(video_player.paused)
          play();
        else 
          pause();
      }

      /**
       * Returns to the previous frame step
       */
       function return_to_step() {
        video_player.currentTime = past_steps.pop();
        pause();
        update();
        gotostep_text.value = step;
        return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
      }

      /**
       * Updates the plots and time selector
       */
       function go_to_step(event) {
        if (event.keyCode === 13) {
          past_steps.push(step);
          video_player.currentTime = Number(gotostep_text.value);
          pause();
          update();
          gotostep_text.value = step;
          return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
        }
      }

      function set_video_speed(event) {
        if (event.keyCode === 13) {
          video_player.playbackRate = Number(video_speed.value);
        }
      }

      /**
       * Updates the plots and time selector
       */
       function top_scores() {
        if (event.keyCode === 13) update()
      }

      /**
      * Pauses video
      */
      function pause() {
          play_pause_button.innerHTML = "Play";
          video_player.pause();
      }

      /**
      * Plays the video
      */
      function play() {
          play_pause_button.innerHTML = "Pause";
          video_player.play();
      }

      /**
      * Resets the video and plots to the start
      */
      function reset() {
          video_player.currentTime = 0;
          past_steps.push(step);
          pause();
          update();
          return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
      }

      /**
      * Goes to the previous frame
      */
      function back() {
          video_player.currentTime = video_player.currentTime - tS_step_size
          pause();
          update();
          past_steps.push(step + 1);
          return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
      }

      /**
      * Goes to the next frame
      */
      function next() {
          video_player.currentTime = video_player.currentTime + tS_step_size;
          pause();
          update();
          past_steps.push(step - 1);
          return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
      }

      /**
       * Switches between general and transformer statistics
       */
       function statistic() {
        if (stats_button.innerHTML == "General") {
          statistic_type = "general";
          stats_button.innerHTML = "Transformer";
        }
        else if (stats_button.innerHTML == "Attention Scores") {
          statistic_type = "transformer";
          stats_button.innerHTML = "General";
        }
        update();
      }
      /**
      * Opens the video in fullscreen
      */
      function open_fullscreen(vid_elem) {
          if (vid_elem.requestFullscreen) {
              vid_elem.requestFullscreen();
          } else if (vid_elem.webkitRequestFullscreen) { /* Safari */
              vid_elem.webkitRequestFullscreen();
          } else if (vid_elem.msRequestFullscreen) { /* IE11 */
              vid_elem.msRequestFullscreen();
          }
          vid_elem.pause();
      }

      // Selects the action space for the entropy plot
      function set_action_space(spaces){
        if (spaces == 'all')
          entr_selected_action_space = null;
        else
          entr_selected_action_space = Number(spaces);
        update();
      }

      function marker(marker_id){
        if(marker_id == "entropy")
          entropy_marker = !entropy_marker;
        else if(marker_id == "value")
          value_marker = !value_marker;
        update();
      }

      /**
      * Updates the plots and time selector
      */
      function update()  {
        if(video_player.currentTime == Math.round(video_player.currentTime)) // If time t of video is a natural number then step is t - 1
              video_player.currentTime += 0.0001 // Add a small number to make sure that the step and the current time are the same
        if(video_player.currentTime > video_length) {
           video_player.currentTime = video_length;
           pause();
        } // Video can't go past the end
        time_selector.value = video_player.currentTime; // Update time selector
        step = Math.floor(video_player.currentTime); // Get step of video for plots

        // Update plots
        if (statistic_type == "general")
          render_general_statistics();
        else if (statistic_type == "transformer")
          render_transformer_statistics();

        if(statistic_type == "general") {
          // Reset plot id
          statistic_plot_id = 0;
          // Update action plot
          if(is_discrete) { // If action_space is discrete
            set_bar_action_plot(y_action[step][0], action[step][0], action_names);
          }
          else { // If action_space is multi discrete
              set_stacked_bar_action_plot(y_action[step], action[step], action_names);
          }
        }
      }

      /**
      * Renders the general statistics
      */
      function render_general_statistics() {
        // Disables the transformer statistics and enables the general statistics
          document.getElementById('transformer').style.display = 'none';
          document.getElementById('top_n_scores').style.display = 'none';
          document.querySelector('label[for="top_n_scores"]').style.display = 'none';
          document.getElementById('value_func').style.display = 'block';
          document.getElementById('entropy_func').style.display = 'block';
          document.getElementById('options').style.display = 'block';
        // Updates the plots
          set_scatter_line_plot('value_func', "Value Function", y_values_plot, step, value_marker);
          if(is_discrete) { // If action_space is discrete
              set_scatter_line_plot('entropy_func', "Entropy Function", y_entropy_plot, step, entropy_marker);
          }
          else { // If action_space is multi discrete
              set_scatter_lines_plot('entropy_func', "Entropy Function", y_entropy_plot, step, entropy_marker);
          }
        }
      
      /*
      * Renders the transformer statistics
      */
      function render_transformer_statistics() {
        // Disables the general statistics and enables the transformer statistics
        document.getElementById('transformer').style.display = 'block';
        document.getElementById('top_n_scores').style.display = 'block';
        document.querySelector('label[for="top_n_scores"]').style.display = 'block';
        document.getElementById('value_func').style.display = 'none';
        document.getElementById('entropy_func').style.display = 'none';
        document.getElementById('options').style.display = 'none';
        // Updates the plots
        var top_n = Number(top_n_scores.value);
        if (top_n == -1) top_n = step;
        visualizeAttentionScores(y_attention_weights[step], top_n);
        }


      /**
       * Renders attention scores
      */
      async function visualizeAttentionScores(attentionScores, n_values) {
        const numHeads = attentionScores.length;
        
        let data = [];
        let layout = {
          grid: {
              rows: numHeads, 
              columns: 1, 
              pattern: 'independent',
              subplots: [...Array(numHeads).keys()].map(i => `xy${i + 1}`),
              ygap: 0.4 // adjust this value according to your preference
          },
          plot_bgcolor: '#000',
          paper_bgcolor: '#000',
          font: {
              family: 'Montserrat',
              size: 12,
              color: '#fff'
          },
          margin: {
              t: 0,  // reduce top margin
          },
      }

        // Flatten the array to find the max value across all arrays
        let flatScores = attentionScores.flat();
        let maxScore = Math.max(...flatScores);

        // Iterate through each attention head
        for (let headIdx = 0; headIdx < numHeads; headIdx++) {
            // Get attention scores for the current head
            let headScores = attentionScores[headIdx];
            
            // This array will keep up to the 10 highest scores
            let topScores = [];

            for (let i = 0; i < headScores.length; i++) {
                // Insert current score into the top scores array
                topScores.push({score: headScores[i], index: i});
                
                // Sort the top scores array
                topScores.sort((a, b) => b.score - a.score);

                // If there are more than 10 scores, remove the smallest
                if (topScores.length > n_values) {
                    topScores.pop();
                }
            }

            // Sort the topScores array by index
            topScores.sort((a, b) => a.index - b.index);

            // Now topScores contains the top 10 scores sorted by their indices.
            // You can extract the scores and their indices into separate arrays:
            let filteredHeadScores = topScores.map(x => x.score);
            let filteredTicks = topScores.map(x => x.index);


            const sequenceLength = filteredHeadScores.length;

            layout.height = 400;
            layout.width = window.innerWidth;

            const headScoresPlot = {
                z: [filteredHeadScores],
                type: 'heatmap',
                showscale: true,  
                colorscale: 'Hot',
                zmin: 0,
                zmax: maxScore,
                xaxis: `x${headIdx + 1}`,
                yaxis: `y${headIdx + 1}`,
            };

            data.push(headScoresPlot);

            layout[`xaxis${headIdx + 1}`] = {
                tickmode: 'array',
                tickvals: Array.from({length: sequenceLength}, (_, i) => i),
                ticktext: filteredTicks
            };

            layout[`yaxis${headIdx + 1}`] = {
                title: `Block ${headIdx + 1}`,
                ticks: 'outside',
                tick0: 0,
                dtick: 1,
                ticklen: 8,
                tickwidth: 4,
                tickcolor: '#000'
            };
        }

        const config = {responsive: true};

        Plotly.newPlot('transformer', data, layout, config).then(function() {
          var myPlot = document.getElementById('transformer');
          myPlot.on('plotly_click', function(data){
            // Jump to the step that was clicked
              past_steps.push(step);
              video_player.currentTime = Number(data.points[0].xaxis.ticktext[data.points[0].x]);
              pause();
              update();
              return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
          });
      });
    }

      /** 
      * Sets a stacked bar plot for the multi discrete action distribution
      * @param {array} y_values - The action distribution
      * @param {array} action - The action
      * @param {array} action_names - The names of the actions
      */
      function set_stacked_bar_action_plot(y_values, action, action_names) {
        var bar_plot_data_action = [];
        // Set data for each action
        for(var j = 0; j < action_names[0].length; j++) {
            var color = ""
            for(var i = 0; i < action_names.length; i++) {
                if(action[i] == j) // If action sampled in the current frame
                    color = '#FF0000'; // Color it red
                else
                    color = '#FAEBD7'; // Color it white
                var trace = {
                    x: [["action_space_", String(i)].join("")],
                    y: [y_values[i][j]],
                    text: [y_values[i][j], action_names[i][j]].map(String).join("<br>"), // Add action name and prob to the bar
                    marker: {
                        color: color,
                        line: {
                            color: '#000000',
                            width: 1
                          }
                    },
                    type: 'bar'
                };
                bar_plot_data_action.push(trace);
            }
        }

        // Set layout for the plot
        var bar_plot_layout_action = {
            autosize: true,
            width: 600,
            height: 360,
            margin: {
                l: 28,
                r: 0,
                b: 30,
                t: 22,
                pad: 4
              },
            plot_bgcolor: '#000',
            paper_bgcolor: '#000',
            font: {
                family: 'Montserrat',
                size: 12,
                color: '#fff'
            },
            title: {
                text: 'Action Distribution',
                font: {
                    family: 'Montserrat',
                    size: 15,
                    color: '#fff'
                }
            },
            barmode: 'stack',
            showlegend: false
      };

      // Plot the data
      Plotly.newPlot('action_distr', bar_plot_data_action, bar_plot_layout_action);
      }

      /**
      * Sets a bar plot for the discrete action distribution
      */
      function set_bar_action_plot(y_values, action, action_names) {

          var color_value = new Array(y_values.length).fill('#FAEBD7'); // Set color for all actions to white
          color_value[action] = '#FF0000'; // Except the selected action should be red
          // Set data for the plot
          var bar_plot_data_action = [
              {
                  x: action_names,
                  y: y_values,
                  type: 'bar',
                  marker: {
                      color: color_value
                  },
                  textposition: 'auto',
                  text: y_values.map(String), // Add prob to the bar plot
                  textfont: {
                      family: 'Montserrat',
                      size: 12,
                  },
                  textangle: 0,
                  textposition: 'bottom center',
              }
          ];

          // Set layout for the plot
          var bar_plot_layout_action = {
            autosize: true,
            width: 600,
            height: 360,
            margin: {
                l: 28,
                r: 0,
                b: 30,
                t: 22,
                pad: 4
              },
            yaxis: {
              automargin: true,
            },
            plot_bgcolor: '#000',
            paper_bgcolor: '#000',
            font: {
                family: 'Montserrat',
                size: 12,
                color: '#fff'
            },
            title: {
                text: 'Action Distribution',
                font: {
                    family: 'Montserrat',
                    size: 15,
                    color: '#fff'
                }
            }
      };
          
          // Plot the action distribution
          Plotly.newPlot('action_distr', bar_plot_data_action, bar_plot_layout_action);
      }


      /**
      * Sets a scatter plot for the emtropy function if multi discrete actions are used
      * @param {string} id - The id of the plot
      * @param {string} title - The title of the plot
      * @param {array} y_values - The entropy function y values
      * @param {int} step - The step of the video
      * @param {boolean} marker - If the marker should be shown
      */
      function set_scatter_lines_plot(id, title, y_values, step, marker) {
        line_scatter_plot_data_value = [];

        // Set colors and data for the plot
        var colors = ['#FAEBD780', '#7CFC0080', '#FFBF0080', '#FF7F5080', '#DE316380', '#9FE2BF80', '#40E0D080', '#6495ED80', '#CCCCFF80']
        for(var i = 0; i < y_values.length; i++) {
          var x_values_marker = x_values.slice(0, step + 1);
          var y_values_marker = y_values[i].slice(0, step + 1);
            var trace = [
            {
                x: x_values_marker,
                y: y_values_marker,
                mode: 'line',
                line: {
                    color: colors[i]
                },
                name: 'action_space_' + String(i),
                showlegend: true,
            },
            {
                x: x_values,
                y: y_values[i],
                mode: 'markers',
                name: 'action_space_' + String(i) + "_marker",
                marker: {
                    color: colors[i]
                },
                showlegend: true,
            }
        ];
            // Add data to the plot
            line_scatter_plot_data_value.push(trace[0]);
            if(marker)
              line_scatter_plot_data_value.push(trace[1]); 
        }

        // Select the selected action_space for the entropy plot
        if(entr_selected_action_space != null && marker)
          line_scatter_plot_data_value = [line_scatter_plot_data_value[entr_selected_action_space * 2], line_scatter_plot_data_value[entr_selected_action_space * 2 + 1]];
        else if(entr_selected_action_space != null && !marker)
          line_scatter_plot_data_value = [line_scatter_plot_data_value[entr_selected_action_space]];

        // Set layout for the plot
        var line__scatter_plot_layout_value = {
            autosize: true,
            width: 600,
            height: 360,
            margin: {
                l: 50,
                r: 0,
                b: 30,
                t: 25,
                pad: 4
                },
            yaxis: {
                automargin: true
            },
            plot_bgcolor: '#000',
            paper_bgcolor: '#000',
            font: {
                family: 'Montserrat',
                size: 12,
                color: '#fff'
            },
            title: {
                text: title,
                font: {
                    family: 'Montserrat',
                    size: 15,
                    color: '#fff'
                }
            },
            showlegend: true,
        };

        // Plot the data
        Plotly.newPlot(id, line_scatter_plot_data_value, line__scatter_plot_layout_value);
        // Add event handler for clicking on a marker
        document.getElementById(id).on('plotly_click', function(data){
            past_steps.push(step);
            video_player.currentTime = Number(data.points[0].x);
            pause();
            update();
            return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
          });
      }


      /**
      * Sets a scatter plot for the value function
      * @param {string} id - The id of the plot
      * @param {string} title - The title of the plot
      * @param {array} y_values - The value function y values
      * @param {int} step - The step of the video
      * @param {boolean} marker - If the marker should be shown
      */
      function set_scatter_line_plot(id, title, y_values, step, marker) {
          // Set data for layout for the plot
          var line__scatter_plot_layout_value = {
              autosize: true,
              width: 600,
              height: 360,
              margin: {
                  l: 50,
                  r: 0,
                  b: 30,
                  t: 25,
                  pad: 4
                  },
              yaxis: {
                  automargin: true
              },
              plot_bgcolor: '#000',
              paper_bgcolor: '#000',
              font: {
                  family: 'Montserrat',
                  size: 12,
                  color: '#fff'
              },
              title: {
                  text: title,
                  font: {
                      family: 'Montserrat',
                      size: 15,
                      color: '#fff'
                  }
              },
              showlegend: false,
          };

          // Set data for the plot
          var x_values_marker = x_values.slice(0, step + 1);
          var y_values_marker = y_values.slice(0, step + 1);

          var line_scatter_plot_data_value = [
              {
                  x: x_values_marker,
                  y: y_values_marker,
                  mode: 'line',
                  line: {
                      color: '#FAEBD7'
                  },
                  name: 'function',
              },
              {
                  x: x_values,
                  y: y_values,
                  mode: 'markers',
                  marker: {
                      color: '#7CFC0080'
                  },
                  name: 'marker',
              }
          ];

          if(!marker)
            line_scatter_plot_data_value = [line_scatter_plot_data_value[0]];

          // Plot the value function
          Plotly.newPlot(id, line_scatter_plot_data_value, line__scatter_plot_layout_value);

          // Add event handler for clicking on a marker
          document.getElementById(id).on('plotly_click', function(data){
            past_steps.push(step);
            video_player.currentTime = Number(data.points[0].x);
            pause();
            update();
            return_button.innerHTML = "Return to step " + past_steps[past_steps.length - 1]; 
          });
      }
    
    /**
    * Opens the specific tab based on the probided id
    * @param {string} id - The id of the tab
    */
    function openTab(evt, id) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        mediatabcontent = document.getElementsByClassName("mediatabcontent");
        // Hide all elements with class="tabcontent" and "mediacontent" by default
        for (i = 0; i < mediatabcontent.length; i++) {
            mediatabcontent[i].style.display = "none";
        }
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        // Show the specific tab content
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(id).style.display = "block";
        evt.currentTarget.className += " active";
      }
    </script>
  </body>
</html>